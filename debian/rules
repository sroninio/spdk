#!/usr/bin/make -f
#  SPDX-License-Identifier: BSD-3-Clause
#  Copyright (c) 2022-2024 NVIDIA CORPORATION & AFFILIATES.
#  All rights reserved.
#
# See debhelper(7) (uncomment to enable)
# output every command that modifies files on the build system.
export DH_VERBOSE = 1
SYSTEMD_DIR=/usr/lib/systemd/system
DEFAULTS_DIR=/etc/default
SPDK_CONF_DIR=/etc/spdk
pkg_prefix=/opt/mellanox/spdk
install_datadir=/usr/share/spdk
ARCH := $(shell uname -m)
OS := $(shell lsb_release -si)

CONF_OPTS = --prefix=$(pkg_prefix) --disable-tests --disable-unit-tests --with-crypto
CONF_OPTS += --without-fio --with-vhost --without-rbd --with-rdma=mlx5_dv
CONF_OPTS += --without-vtune --with-iscsi-initiator --with-shared --without-uring --with-raid5f

ifeq ($(OS), Ubuntu)
  CONF_OPTS += --with-xlio
endif

export DEB_LDFLAGS_MAINT_APPEND = -Wl,-rpath,$(pkg_prefix)/lib

%:
	dh $@

override_dh_auto_configure:
	# for some reason ./configure -- --options are ignored
	# so that let's use preconfigure debian/CONFIG on Ubuntu
	cp -p debian/CONFIG CONFIG
	sed -i 's#CONFIG_PREFIX="/usr.*"#CONFIG_PREFIX="'$(pkg_prefix)'"#' CONFIG
	# Use armv8-a on aarch64
	test $(ARCH) != aarch64 || sed -i 's#CONFIG_ARCH=.*#CONFIG_ARCH=armv8-a#' CONFIG
	# XLIO
	test $(OS) != Ubuntu || sed -i 's#CONFIG_XLIO=.*#CONFIG_XLIO=y#' CONFIG
	LDFLAGS="$$LDFLAGS -Wl,-rpath,$(pkg_prefix)/lib" ./configure $(CONF_OPTS)

override_dh_auto_clean:
	test -e mk/config.mk && make distclean || true

#install:
override_dh_auto_install:
	mkdir -p debian/tmp/usr/bin
	mkdir -p debian/tmp/usr/sbin
	mkdir -p debian/tmp/etc/default
	mkdir -p debian/tmp/usr/lib/systemd/system
	mkdir -p debian/tmp/etc/spdk
	mkdir -p debian/tmp/etc/bash_completion.d
	mkdir -p debian/tmp$(pkg_prefix)
	mkdir -p debian/tmp$(install_datadir)/scripts
	mkdir -p debian/tmp$(install_datadir)/include/spdk
	dh_auto_install -- prefix=$(pkg_prefix)
	rm -f debian/tmp$(pkg_prefix)/bin/*.py
	rm -f debian/tmp$(pkg_prefix)/bin/igzip
	rm -f debian/tmp$(pkg_prefix)/bin/spdk_cli
	rm -f debian/tmp$(pkg_prefix)/bin/spdk_rpc
	install -p -m 755 debian/tmp$(pkg_prefix)/bin/* debian/tmp/usr/sbin
	patchelf --set-rpath $(pkg_prefix)/lib --force-rpath debian/tmp/usr/sbin/*
	install -p -m 755 contrib/setup_nvmf_tgt.py debian/tmp/usr/sbin
	install -p -m 755 contrib/setup_vhost.py debian/tmp/usr/sbin
	install -p -m 755 contrib/vhost_add_config.sh debian/tmp/usr/sbin
	install -p -m 755 contrib/setup_hugepages.sh debian/tmp/usr/sbin
	install -m 644 contrib/spdk_tgt.service debian/tmp$(SYSTEMD_DIR)/
	install -m 644 contrib/vhost.service debian/tmp$(SYSTEMD_DIR)/
	install -m 644  contrib/default/spdk_tgt debian/tmp$(DEFAULTS_DIR)/
	install -m 644  contrib/default/vhost debian/tmp$(DEFAULTS_DIR)/
	install -m 644 contrib/vhost.conf.example debian/tmp$(SPDK_CONF_DIR)/
	install -p -m 755 scripts/setup.sh debian/tmp$(install_datadir)/scripts
	install -m 644 scripts/common.sh debian/tmp$(install_datadir)/scripts
	install -p -m 755 scripts/spdk-gpt.py debian/tmp$(install_datadir)/scripts
	install -m 644 include/spdk/pci_ids.h debian/tmp$(install_datadir)/include/spdk
	install -p -m 644 scripts/bash-completion/spdk debian/tmp/etc/bash_completion.d
	sed -i -e 's/ rpc.py/ spdk_rpc.py/' debian/tmp/etc/bash_completion.d/spdk
	for so in debian/tmp$(pkg_prefix)/lib/lib*so.*; do \
		patchelf --set-rpath /opt/mellanox/spdk/lib --force-rpath $$so || true; \
	done
	rm -rf debian/tmp$(pkg_prefix)/share/dpdk/examples
	(cd scripts ; python3 setup.py install --install-layout=deb --root=../debian/tmp )
	mv debian/tmp/usr/bin/spdkcli.py debian/tmp/usr/bin/spdkcli

# Prevent dh_installdeb of treating files in /etc as configuration files
# you need this if need configuration files been always rewritten
# even if changed
override_dh_installdeb:
	dh_installdeb
	rm debian/*/DEBIAN/conffiles

override_dh_shlibdeps:
	dh_shlibdeps --dpkg-shlibdeps-params=--ignore-missing-info -l$(shell pwd)/debian/tmp$(pkg_prefix)/lib

override_dh_builddeb:
	dh_builddeb -- -Zxz

#override_dh_install:
#	dh_install
#override_dh_usrlocal:
#	true
